<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Telemetry Capturing is the process of recording the logs and traces happening during a request to the binary engine, and rendering them in the response."><title>query_core::telemetry::capturing - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-9bb858ba049f1f21.css" id="mainThemeStyle"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="query_core" data-themes="" data-resource-suffix="" data-rustdoc-version="1.72.0 (5680fa18f 2023-08-23) (built from a source tarball)" data-channel="1.72.0" data-search-js="search-f6292fe389d70017.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-0f8c037637f9eb3e.css" data-theme-dark-css="dark-1097f8e92a01e3cf.css" data-theme-ayu-css="ayu-614652228113ac93.css" ><script src="../../../static.files/storage-59fd9b8ccb335783.js"></script><script defer src="../../../static.files/main-0795b7d26be81095.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../../static.files/light-0f8c037637f9eb3e.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../../static.files/dark-1097f8e92a01e3cf.css"><link rel="stylesheet" href="../../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../../query_core/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../../query_core/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module capturing</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#traits">Traits</a></li><li><a href="#functions">Functions</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../index.html">query_core</a>::<wbr><a href="../index.html">telemetry</a>::<wbr><a class="mod" href="#">capturing</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../../src/query_core/telemetry/capturing/mod.rs.html#1-197">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Telemetry Capturing is the process of recording the logs and traces happening during a request
to the binary engine, and rendering them in the response.</p>
<p>The interaction diagram below (soorry width!) shows the different roles at play during telemetry
capturing. A textual explanatation follows it. For the sake of example a server environment
–the query-engine crate– is assumed.</p>
<h2 id="--------------------"><a href="#--------------------">┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐</a></h2><h2 id=""><a href="#"></a></h2><h2 id="-------------------------"><a href="#-------------------------">│              &lt;<concurrent>&gt;           │</a></h2><h2 id="-1"><a href="#-1"></a></h2><h2 id="--------------------------1"><a href="#--------------------------1">╔═══════════════════════╗   │╔═══════════════╗                      │</a></h2><h2 id="spanprocessor-sync------------"><a href="#spanprocessor-sync------------">║&lt;&lt;SpanProcessor, Sync&gt;&gt;║    ║ &lt;<ch sender>&gt; ║    ╔════════════════╗  ╔═══════════════════╗</a></h2><h2 id="---------------------------------------processor--------------sender-------------storage------------tracer-------"><a href="#---------------------------------------processor--------------sender-------------storage------------tracer-------">┌───────────────────┐                                ║       PROCESSOR       ║   │║    Sender     ║    ║    Storage     ║│ ║      TRACER       ║</a></h2><h2 id="------server-------------------------------------------------"><a href="#------server-------------------------------------------------">│      Server       │                                ╚═══════════╦═══════════╝    ╚══════╦════════╝    ╚═══════╦════════╝  ╚═════════╦═════════╝</a></h2><h2 id="-----------------------------------------------------------------------------------------------------------"><a href="#-----------------------------------------------------------------------------------------------------------">└─────────┬─────────┘                                            │               │       │                     │         │           │</a></h2><h2 id="-----------------------------------------------------------------------------------------------------------------------"><a href="#-----------------------------------------------------------------------------------------------------------------------">│                                                      │                       │                     │                     │</a></h2><h2 id="---------------------------------------------------------------------------------------------------------------------"><a href="#---------------------------------------------------------------------------------------------------------------------">│                                                      │               │       │                     │         │           │</a></h2><h2 id="post-----------------------------------------------------------------------------------------------------------------------------"><a href="#post-----------------------------------------------------------------------------------------------------------------------------">POST      │                                                      │                       │                     │                     │</a></h2><h2 id="body-headers---------------------------------------------------------------------------------------------------------------------"><a href="#body-headers---------------------------------------------------------------------------------------------------------------------">(body, headers)│                                                      │               │       │                     │         │           │</a></h2><h2 id="----------------------------------------------------------------------------------------------------------------------"><a href="#----------------------------------------------------------------------------------------------------------------------">──────────▶┌┴┐                                                     │                       │                     │                     │</a></h2><h2 id="-----newheaders------------------------------------------------------------------------------------------"><a href="#-----newheaders------------------------------------------------------------------------------------------">┌─┐    │ │new(headers)╔════════════╗                           │               │       │                     │         │           │</a></h2><h2 id="1-----s-settings---------------------------------------------------------------------------------------------"><a href="#1-----s-settings---------------------------------------------------------------------------------------------">│1│    │ ├───────────▶║s: Settings ║                           │                       │                     │                     │</a></h2><h2 id="------------------------------------------------------------------------------------------------------------1"><a href="#------------------------------------------------------------------------------------------------------------1">└─┘    │ │            ╚════════════╝                           │               │       │                     │         │           │</a></h2><h2 id="------------------------------------------------------------------------------------------------------------------------1"><a href="#------------------------------------------------------------------------------------------------------------------------1">│ │                                                     │                       │                     │                     │</a></h2><h2 id="------------------------------------------------------------------------------------------------"><a href="#------------------------------------------------------------------------------------------------">│ │                    ╔═══════════════════╗            │               │       │                     │         │           │</a></h2><h2 id="----------------------capturerenabled---------------------------------------------------------------------------------------------------"><a href="#----------------------capturerenabled---------------------------------------------------------------------------------------------------">│ │                    ║ Capturer::Enabled ║            │                       │                     │                     │                     ┌────────────┐</a></h2><h2 id="----------------------------------------------------------------------------------------------------------------------1"><a href="#----------------------------------------------------------------------------------------------------------------------1">│ │                    ╚═══════════════════╝            │               │       │                     │         │           │                     │&lt;<Somewhere>│</a></h2><h2 id="-------------------------------------------------------------------------------------------------------------------------------------------"><a href="#-------------------------------------------------------------------------------------------------------------------------------------------">│ │                              │                      │                       │                     │                     │                     └──────┬─────┘</a></h2><h2 id="------newtrace_id-s-----------------------------------------------------------------------------------------------------------------------"><a href="#------newtrace_id-s-----------------------------------------------------------------------------------------------------------------------">│ │   ┌─┐  new(trace_id, s)      │                      │               │       │                     │         │           │                            │</a></h2><h2 id="-2-------------------------------------------------------------------------------------------------------------------"><a href="#-2-------------------------------------------------------------------------------------------------------------------">│ ├───┤2├───────────────────────▶│                      │                       │                     │                     │                            │</a></h2><h2 id="---------------------------------------------------------------------------------------------------------------------------------------------"><a href="#---------------------------------------------------------------------------------------------------------------------------------------------">│ │   └─┘                        │                      │               │       │                     │         │           │                            │</a></h2><h2 id="--------------------------------------------------------------------------------------------------------------------------------------------------"><a href="#--------------------------------------------------------------------------------------------------------------------------------------------------">│ │                              │                      │                       │                     │                     │                            │</a></h2><h2 id="-----start_capturing---------start_capturing-----------------------------------------------------------------------------------------------"><a href="#-----start_capturing---------start_capturing-----------------------------------------------------------------------------------------------">│ │   ┌─┐ start_capturing()      │   start_capturing    │               │       │                     │         │           │                            │</a></h2><h2 id="-3----trace_id-s--------------------------------------------------------------------------------------------------"><a href="#-3----trace_id-s--------------------------------------------------------------------------------------------------">│ ├───┤3├───────────────────────▶│    (trace_id, s)     │                       │                     │                     │                            │</a></h2><h2 id="----------------------------------------------------------------------------------------------------------------------------------------------1"><a href="#----------------------------------------------------------------------------------------------------------------------------------------------1">│ │   └─┘                        │                      │               │       │                     │         │           │                            │</a></h2><h2 id="--------------------------------sendstartcapturing------------------------------------------------------------------------"><a href="#--------------------------------sendstartcapturing------------------------------------------------------------------------">│ │                              ├─────────────────────▶│ send(StartCapturing,  │                     │                     │                            │</a></h2><h2 id="-----------------------------------------------------------trace_id----------------------------------------------------------------------------"><a href="#-----------------------------------------------------------trace_id----------------------------------------------------------------------------">│ │                              │                      │      trace_id)│       │                     │         │           │                            │</a></h2><h2 id="----------------------------------------------------------------------------------------------------------------------------------"><a href="#----------------------------------------------------------------------------------------------------------------------------------">│ │                              │                      │── ── ── ── ── ── ── ─▶│                     │                     │                            │</a></h2><h2 id="------------------------------------------------------------------------inserttrace_id-s--------------------------------------------------"><a href="#------------------------------------------------------------------------inserttrace_id-s--------------------------------------------------">│ │                              │                      │        ┌─┐    │       │insert(trace_id, s)  │         │           │                            │</a></h2><h2 id="-------------------------------------------------------------4-------------------------------------------------------------"><a href="#-------------------------------------------------------------4-------------------------------------------------------------">│ │                              │                      │        │4│            │────────────────────▶│                     │                            │</a></h2><h2 id="------------------------------------------------------------------------------------------------------------------------process_query-----"><a href="#------------------------------------------------------------------------------------------------------------------------process_query-----">│ │                              │                      │        └─┘    │       │                     │         │  ┌─┐      │          process_query     │</a></h2><h2 id="-5"><a href="#-5">│ │──────────────────────────────┼──────────────────────┼───────────────────────┼─────────────────────┼────────────┤5├──────┼──────────────────────────▶┌┴┐</a></h2><h2 id="----------------------------------------------------------------------------------------------------------------------------------------------2"><a href="#----------------------------------------------------------------------------------------------------------------------------------------------2">│ │                              │                      │               │       │                     │         │  └─┘      │                           │ │</a></h2><h2 id="---------------------------------------------------------------------------------------------------------------------------------------------------1"><a href="#---------------------------------------------------------------------------------------------------------------------------------------------------1">│ │                              │                      │                       │                     │                     │                           │ │</a></h2><h2 id="---------------------------------------------------------------------------------------------------------------------------------------------------2"><a href="#---------------------------------------------------------------------------------------------------------------------------------------------------2">│ │                              │                      │               │       │                     │         │           │                           │ │  ┌─────────────────────┐</a></h2><h2 id="---------------------------------------------------------------------------------------------------------------------------log--span-----------res-prismaresponse-"><a href="#---------------------------------------------------------------------------------------------------------------------------log--span-----------res-prismaresponse-">│ │                              │                      │                       │                     │                     │     log! / span!     ┌─┐  │ │  │ res: PrismaResponse │</a></h2><h2 id="--------------------------------------------------------------------------------------------------------------------6---"><a href="#--------------------------------------------------------------------------------------------------------------------6---">│ │                              │                      │               │       │                     │         │           │◀─────────────────────┤6├──│ │  └──────────┬──────────┘</a></h2><h2 id="--------------------------------------------------------------------------------on_endspan_data----------------------------------------------new-------"><a href="#--------------------------------------------------------------------------------on_endspan_data----------------------------------------------new-------">│ │                              │                      │                       │    on_end(span_data)│            ┌─┐      │                      └─┘  │ │   new       │</a></h2><h2 id="-----------------------------------------------------7----------------------------"><a href="#-----------------------------------------------------7----------------------------">│ │                              │                      │◀──────────────┼───────┼─────────────────────┼─────────┼──┤7├──────┤                           │ │────────────▶│</a></h2><h2 id="------------------------------------------------------sendspandataprocessed--------------------------------------------------------------------------------"><a href="#------------------------------------------------------sendspandataprocessed--------------------------------------------------------------------------------">│ │                              │                      │ send(SpanDataProcessed│                     │            └─┘      │                           │ │             │</a></h2><h2 id="------------------------------------------------------------trace_id---------appendtrace_id---------------------------------------------------------------"><a href="#------------------------------------------------------------trace_id---------appendtrace_id---------------------------------------------------------------">│ │                              │                      │      , trace_id)      │   append(trace_id,  │         │           │                           │ │             │</a></h2><h2 id="-----------------------------------------------------------------logs-traces-----------------------------------------------------------------"><a href="#-----------------------------------------------------------------logs-traces-----------------------------------------------------------------">│ │                              │                      │── ── ── ── ── ── ── ─▶│     logs, traces)   │                     │                           │ │             │</a></h2><h2 id="-------------------------------------------------------------------------------------------------------------------------------------"><a href="#-------------------------------------------------------------------------------------------------------------------------------------">│ │                              │                      │        ┌─┐    │       ├────────────────────▶│         │           │                           │ │             │</a></h2><h2 id="-------------------------------------------------------------8-----------------------------------------------------------------------------------------------"><a href="#-------------------------------------------------------------8-----------------------------------------------------------------------------------------------">│ │                              │                      │        │8│            │                     │                     │                           │ │             │</a></h2><h2 id="-------res-prismaresponse-----------------------------------------------------------------------------------------------------------------------------"><a href="#-------res-prismaresponse-----------------------------------------------------------------------------------------------------------------------------">│ │      res: PrismaResponse     │ ┌─┐                  │        └─┘    │       │                     │         │           │                           │ │             │</a></h2><h2 id="-----------------9--------------return-------------------------------------------------"><a href="#-----------------9--------------return-------------------------------------------------">│ │─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┼ ┤9├ ─ ─ ─ ─ ─ ─ ─ ─ ─│─ ─ ─ ─ ─ ─return ─ ─ ─│─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─└┬┘             │</a></h2><h2 id="---fetch_captures----------------------------------------------------------------------------------------------------------------------------------"><a href="#---fetch_captures----------------------------------------------------------------------------------------------------------------------------------">│ │ ┌────┐ fetch_captures()      │ └─┘                  │               │       │                     │         │           │                            │              │</a></h2><h2 id="--10-------fetch_captures-------------------------------------------------------------------------------------------------------------"><a href="#--10-------fetch_captures-------------------------------------------------------------------------------------------------------------">│ ├─┤ 10 ├──────────────────────▶│      fetch_captures  │                       │                     │                     │                            │              │</a></h2><h2 id="---------------------------------trace_id-------------------------------------------------------------------------------------------------------------"><a href="#---------------------------------trace_id-------------------------------------------------------------------------------------------------------------">│ │ └────┘                       │        (trace_id)    │               │       │                     │         │           │                            │              │</a></h2><h2 id="---------------------------------sendfetchcaptures------------------------------------------------------------------------x--------------"><a href="#---------------------------------sendfetchcaptures------------------------------------------------------------------------x--------------">│ │                              ├─────────────────────▶│  send(FetchCaptures,  │                     │                     │                            x              │</a></h2><h2 id="------------------------------------------------------------trace_id-------------------------------------------------------------------------------------------"><a href="#------------------------------------------------------------trace_id-------------------------------------------------------------------------------------------">│ │                              │                      │       trace_id)       │                     │         │           │                                           │</a></h2><h2 id="---------------------------------------------------------------get-logstraces-------------------------------------------------------------------"><a href="#---------------------------------------------------------------get-logstraces-------------------------------------------------------------------">│ │                              │                      │── ── ── ── ── ── ── ─▶│   get logs/traces   │                     │                                           │</a></h2><h2 id="------------------------------------------------------------------------------------------------------------------------------------"><a href="#------------------------------------------------------------------------------------------------------------------------------------">│ │                              │                      │      ┌────┐   │       ├─────────────────────▶         │           │                                           │</a></h2><h2 id="------------------------------------------------------------11-------------------------------------------------------------------------------------------------"><a href="#------------------------------------------------------------11-------------------------------------------------------------------------------------------------">│ │                              │                      │      │ 11 │           │                     │                     │                                           │</a></h2><h2 id="----------------------------------------------------------------------------------------------------------------------------------------------"><a href="#----------------------------------------------------------------------------------------------------------------------------------------------">│ │                              │                      │      └────┘   │       │◁ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│         │           │                                           │</a></h2><h2 id="-----------------------------------------------------------------------------------------------------------------------------------------------------------------"><a href="#-----------------------------------------------------------------------------------------------------------------------------------------------------------------">│ │                              │                      │                       │                     │                     │                                           │</a></h2><h2 id="----------------------------------------------------------------------------------------------------------------------------------------------------"><a href="#----------------------------------------------------------------------------------------------------------------------------------------------------">│ │                              ◁ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│               │       │                     │         │           │                                           │</a></h2><h2 id="-----------logs-traces------------------------------------------------------------------------------------------------------------------------------------------"><a href="#-----------logs-traces------------------------------------------------------------------------------------------------------------------------------------------">│ │          logs, traces        │                      │                       │                     │                     │                                           │</a></h2><h2 id="-----------------------------------------------------------------------------------------------------------------------------------------------"><a href="#-----------------------------------------------------------------------------------------------------------------------------------------------">│ │◁─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                      │               │       │                     │         │           │                                           │</a></h2><h2 id="-------------------------------x-------------------------------------------------------------------------------------------------resset_extensionlogs----"><a href="#-------------------------------x-------------------------------------------------------------------------------------------------resset_extensionlogs----">│ │                              x        ┌────┐        │                       │                     │                     │                res.set_extension(logs)    │</a></h2><h2 id="--12-"><a href="#--12-">│ ├───────────────────────────────────────┤ 12 ├────────┼───────────────┼───────┼─────────────────────┼─────────┼───────────┼──────────────────────────────────────────▶│</a></h2><h2 id="---------------------------------------------------------------------------------------------------------------------------------resset_extensiontraces--"><a href="#---------------------------------------------------------------------------------------------------------------------------------resset_extensiontraces--">│ │                                       └────┘        │                       │                     │                     │                res.set_extension(traces)  │</a></h2><h2 id="-"><a href="#-">│ ├─────────────────────────────────────────────────────┼───────────────┼───────┼─────────────────────┼─────────┼───────────┼──────────────────────────────────────────▶│</a></h2><h2 id="--------------------------------------------------------------------------------------------------------------------------------------------------------------------x"><a href="#--------------------------------------------------------------------------------------------------------------------------------------------------------------------x">◀ ─ ─ ─└┬┘                                                     │                       │                     │                     │                                           x</a></h2><h2 id="jsonres--------------------------------------------------------------------------------------------------------------"><a href="#jsonres--------------------------------------------------------------------------------------------------------------">json!(res) │                                                                      │                                       │</a></h2><h2 id="--------------------------------------------------------------------------------------------"><a href="#--------------------------------------------------------------------------------------------">┌────┐  │                                                                       ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─</a></h2><h2 id="-13---"><a href="#-13---">│ 13 │  │</a></h2><h2 id="-2"><a href="#-2">└────┘</a></h2><h2 id="-3"><a href="#-3"></a></h2><h2 id="-call-pseudo-signatures"><a href="#-call-pseudo-signatures">◀─────── call (pseudo-signatures)</a></h2><h2 id="-4"><a href="#-4"></a></h2><h2 id="---async-message-passing-channels"><a href="#---async-message-passing-channels">◀─ ── ── async message passing (channels)</a></h2><h2 id="-5"><a href="#-5"></a></h2><h2 id="----return"><a href="#----return">◁─ ─ ─ ─ return</a></h2><h2 id="-6"><a href="#-6"></a></h2>
<p>In the diagram, you will see objects whose lifetime is static. The boxes for those have a double
width margin. These are:</p>
<ul>
<li>The <code>server</code> itself</li>
<li>The  global <code>TRACER</code>, which handles <code>log!</code> and <code>span!</code> and uses the global <code>PROCESSOR</code> to
process the data constituting a trace <code>Span</code>s and log <code>Event</code>s</li>
<li>The global <code>PROCESSOR</code>, which manages the <code>Storage</code> set of data structures, holding logs,
traces (and capture settings) per request.</li>
</ul>
<p>Then, through the request lifecycle, different objects are created and dropped:</p>
<ul>
<li>When a request comes in, its headers are processed and a <a href="struct.Settings.html" title="struct query_core::telemetry::capturing::Settings"><code>Settings</code></a> object is built, this
object determines, for the request, how logging and tracing are going to be captured: if only
traces, logs, or both, and which log levels are going to be captured.</li>
<li>Based on the settings, a new <code>Capturer</code> is created; a capturer is nothing but an exporter
wrapped to start capturing / fetch the captures for this particular request.</li>
<li>An asynchronous task is spawned to own the storage of telemetry data without needing to share
memory accross threads. Communication with this task is done through channels. The <code>Sender</code>
part of the channel is kept in a global, so it can be cloned and used by a) the Capturer
(to start capturing / fetch the captures) or by the tracer’s SpanProcessor, to extract
tracing and logging information that’s eventually displayed to the user.</li>
</ul>
<p>Then the capturing process works in this way:</p>
<ul>
<li>The server receives a query <strong>[1]</strong></li>
<li>It grabs the HTTP headers and builds a <code>Capture</code> object <strong>[2]</strong>, which is configured with the settings
denoted by the <code>X-capture-telemetry</code></li>
<li>Now the server tells the <code>Capturer</code> to start capturing all the logs and traces occurring on
the request <strong>[3]</strong> (denoted by a <code>trace_id</code>) The <code>trace_id</code> is either carried on the <code>traceparent</code>
header or implicitly created on the first span of the request.</li>
<li>The <code>Capturer</code> sends a message to the task owning the storage to start capturing <strong>[4]</strong>.
The tasks creates a new entry in the storage for the given trace_id. Spans without a
corresponding trace_id in the storage are ignored.</li>
<li>The server dispatches the request and <em>Somewhere</em> else in the code, it is processed <strong>[5]</strong>.</li>
<li>There the code logs events and emits traces asynchronously, as part of the processing <strong>[6]</strong></li>
<li>Traces and Logs arrive at the <code>TRACER</code>, and get hydrated as SpanData in the <code>PROCESSOR</code>
<strong>[7]</strong>.</li>
<li>This SpanData is sent through a channel to the task running in parallel, <strong>[8]</strong>.
The task transforms the SpanData into <code>TraceSpans</code> and <code>LogEvents</code> depending on the capture
settings and stores those spans and events in the storage.</li>
<li>When the code that dispatches the request is done it returns a <code>PrismaResponse</code> to the
server <strong>[9]</strong>.</li>
<li>Then the server asks the <code>PROCESSOR</code> to fetch the captures <strong>[10]</strong></li>
<li>Like before, the <code>PROCESSOR</code> sends a message to the task running in parallel,
to fetch the captures from the <code>Storage</code> <strong>[11]</strong>. At that time, although
that’s not represented in the diagram, the captures are deleted from the storage, thus
freeing any memory used for capturing during the request</li>
<li>Finally, the server sets the <code>logs</code> and <code>traces</code> extensions in the <code>PrismaResponse</code><strong>[12]</strong>,
it serializes the extended response in json format and returns it as an HTTP Response
blob <strong>[13]</strong>.</li>
</ul>
</div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="storage/index.html" title="mod query_core::telemetry::capturing::storage">storage</a></div></li></ul><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.Settings.html" title="struct query_core::telemetry::capturing::Settings">Settings</a></div></li></ul><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.Capturer.html" title="enum query_core::telemetry::capturing::Capturer">Capturer</a></div><div class="desc docblock-short">Capturer determines, based on a set of settings and a trace id, how capturing is going to be handled.
Generally, both the trace id and the settings will be derived from request headers. Thus, a new
value of this enum is created per request.</div></li></ul><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.TxTraceExt.html" title="trait query_core::telemetry::capturing::TxTraceExt">TxTraceExt</a></div></li></ul><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.capturer.html" title="fn query_core::telemetry::capturing::capturer">capturer</a></div><div class="desc docblock-short">Creates a new capturer, which is configured to export traces and log events happening during a
particular request</div></li><li><div class="item-name"><a class="fn" href="fn.install_capturing_layer.html" title="fn query_core::telemetry::capturing::install_capturing_layer">install_capturing_layer</a></div><div class="desc docblock-short">Adds a capturing layer to the given subscriber and installs the transformed subscriber as the
global, default subscriber</div></li></ul></section></div></main></body></html>